# 智能Mock系统技术设计文档

## 1. 背景与目标

本系统用于将接口文档（Word/PDF）解析为结构化数据，并自动生成可校验、可动态响应的 Mock 服务。目标：

- 自动解析接口文档，抽取接口参数与示例
- 生成 Mock 地址与校验规则
- 支持动态响应与错误响应
- 支持请求日志与统计
- 提供演示级前端页面

## 2. 架构概览

系统由三部分组成：

1. 文档解析与抽取（后端服务）
2. Mock 生成与动态响应（后端服务）
3. 交互与展示（H5 前端）

### 2.1 技术栈

- JDK 8 + Spring Boot 2.x
- Apache POI（Word）
- PDFBox（PDF）
- MySQL（日志与 Mock 持久化）
- 智普 GLM-4.7（抽取与生成）
- 前端：原生 HTML/CSS/JS

## 3. 核心流程

1. 上传 Word/PDF 文档
2. 文档解析为结构化文本（分段 + 表格）
3. 分块过滤（仅保留接口相关内容）
4. 调用大模型生成接口 Mock 信息（请求/响应/错误响应）
5. 生成 Mock 地址并持久化
6. Mock 调用时校验请求并动态响应
7. 记录操作日志与统计

## 4. 关键功能设计

### 4.1 文档解析

- 支持 `.doc/.docx` 和 `.pdf`
- 解析结构化 `sections`：`title, level, content, tables`
- PDF 表格由文本 + 结构化段落组合（表格依赖度低）

### 4.2 关键词过滤与分块

支持三层优先级过滤：

1. 自定义关键词（优先级最高）
2. URL 识别（正则）
3. Request / Response / Example 语义关键词

减少 token 消耗，只提交“接口相关内容”给模型。

### 4.3 Mock 生成

模型输出结构：

- `requestExample`
- `responseExample`
- `errorResponseExample`
- `requiredFields`

### 4.4 动态响应与缓存

对于查询类接口，动态响应规则：

- **关键字段不变**：返回数据库缓存结果
- **关键字段变化**：按示例模板生成新响应，并存入缓存

关键字段由“必填字段 + 常见标识字段”自动推断。

### 4.5 错误响应

请求体带以下字段触发错误响应：

- `__mock_error`
- `__mock_error_code`
- `__mock_error_message`

优先使用 `errorResponseExample`，否则对正常响应进行错误字段替换。

### 4.6 脚本响应模式

除模板 + 动态替换外，支持**脚本响应模式**：

- 在接口编辑中可选择响应模式：**模板（默认）** 或 **脚本**。
- 选择脚本时，可填写一段 JavaScript（Nashorn）。每次请求时传入当前请求上下文 `request`（含 `headers`、`query`、`body`），脚本返回 `{ headers: {}, body: {} }` 作为响应。
- 脚本执行超时 5 秒，异常或超时时回退到 `responseExample`。脚本模式不写响应缓存，每次请求重新执行脚本。
- 安全：仅限可信环境配置脚本；脚本内不暴露 Java 类。

### 4.7 日志与统计

记录操作类日志：

| 类型 | 说明 |
| --- | --- |
| UPLOAD_MOCK | 上传文档生成 mock |
| MOCK_HIT | Mock 命中缓存 |
| MOCK_GEN | 示例响应 |
| MOCK_ERROR | 错误响应 |
| MOCK_VALIDATION_FAIL | 参数校验失败 |

统计指标：

- 总量统计
- 24 小时统计
- 接口维度（当天 / 近 7 天）调用次数

## 5. 数据库设计

### 5.1 Mock 接口表

表：`mock_endpoint`

字段（核心）：

- `id`
- `title`
- `mock_url`
- `request_example`
- `response_example`
- `error_response_example`
- `required_fields`
- `response_mode`（VARCHAR，默认 `template`，可选 `script`）
- `response_script`（TEXT，脚本模式下使用的 JavaScript）
- `source_file_name`
- `source_file_url`
- `created_at`

**数据库迁移**：若表已存在，需手动执行以下 DDL 增加脚本响应字段（或使用 `src/main/resources/db/migration/V1__add_script_response_mode.sql`）：

```sql
ALTER TABLE mock_endpoint
  ADD COLUMN response_mode VARCHAR(32) DEFAULT 'template',
  ADD COLUMN response_script LONGTEXT NULL;
```

### 5.2 Mock 响应缓存表

表：`mock_response_cache`

字段（核心）：

- `id`
- `mock_id`
- `request_signature`
- `request_body`
- `response_body`
- `created_at`

### 5.3 操作日志表

表：`mock_operation_log`

字段（核心）：

- `id`
- `type`
- `mock_id`
- `source_file_name`
- `message`
- `created_at`

## 6. 接口设计

### 6.1 文档上传生成

`POST /parse/endpoint`

返回：Mock 信息列表

### 6.2 Mock 调用

`POST /parse/mock/{id}`

- 校验请求参数
- 动态响应或错误响应

### 6.3 Mock 元信息

`GET /parse/mock/{id}/info`

### 6.4 日志与统计

- `GET /parse/logs`
- `GET /parse/logs/stats`
- `GET /parse/logs/stats/endpoint-today`
- `GET /parse/logs/stats/endpoint-week`

## 7. 安全与扩展

- 可加入 API Token 校验
- 生成规则可配置
- 分块逻辑可调优
- 支持更多文件格式

## 8. 部署与运维

配置项：

```yaml
zhipu:
  api-key: "YOUR_KEY"
  model: "glm-4.7"
  temperature: 0.2
  max-tokens: 2048
spring:
  datasource:
    url: "jdbc:mysql://host:3306/db_mock"
```

## 9. 已知限制

- 文档结构差异大时，解析准确性会下降
- 扫描版 PDF 需要 OCR
- 动态响应依赖模型稳定性

